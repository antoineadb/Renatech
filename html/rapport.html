<?php

include_once 'class/Manager.php';
$db = BD::connecter(); //CONNEXION A LA BASE DE DONNEE
$manager = new Manager($db); //CREATION D'UNE INSTANCE DU MANAGER
if(!empty($_GET['idprojet'])){
    $idprojet=$_GET['idprojet'];
    $numProjet = $manager->getSingle2("select numero from projet where idprojet=?",$idprojet);
}elseif(isset($_GET['numProjet'])){
    $numProjet=$_GET['numProjet'];
    $idprojet = $manager->getSingle2("select idprojet from projet where numero =?",$numProjet);//récupération de l'idprojet à l'aide de $numProjet
}else{
    $idprojet =$_GET['idprojet'];
    $numProjet = $manager->getSingle2("select numero from projet where idprojet=?",$idprojet);
}
$rowModif = $manager->getList2("SELECT contexte,titre,libellecentrale,datedebutprojet FROM projet,concerne,centrale WHERE idprojet = idprojet_projet  AND idcentrale_centrale = idcentrale and idprojet =?",$idprojet);
$titre =stripslashes(removeDoubleQuote($rowModif[0]['titre']));
$Contexteobjectif =filterEditor(stripslashes(removeDoubleQuote($rowModif[0]['contexte'])));
$arrayentity = $manager->getList2("select libellecentrale,codeunite from concerne,centrale where idcentrale_centrale = idcentrale and idprojet_projet=?",$idprojet);
$entityprojet = $arrayentity[0]['libellecentrale'].', '.$arrayentity[0]['codeunite'];
//Funding Source
$sSourcefinancement='';
$arrraySF= $manager->getList2("select libellesourcefinancement,acronymesource from projetsourcefinancement,sourcefinancement where idsourcefinancement_sourcefinancement=idsourcefinancement and idprojet_projet=?",$idprojet);
$nbSF=count($arrraySF);
for($i=0;$i<$nbSF;$i++){
    if($arrraySF[$i]['libellesourcefinancement']==TXT_AUTRES){
        $sSourcefinancement.=$arrraySF[$i]['acronymesource'].',';
    }else{
        $sSourcefinancement.=$arrraySF[$i]['libellesourcefinancement'].',';
    }
}
$s_Sourcefinancement = substr($sSourcefinancement,0,-1);

$rowResult = $manager->getListbyArray("SELECT idutilisateur,nom, prenom, entrepriselaboratoire FROM utilisateur, projet, creer WHERE idutilisateur_utilisateur = idutilisateur AND idprojet_projet = idprojet and idprojet=?",array($idprojet));
$demandeur =$rowResult[0]['nom'].' '.$rowResult[0]['prenom'];
$entrepriselaboratoireo=stripslashes(
removeDoubleQuote($rowResult[0]['entrepriselaboratoire']));
$arrayvillepays=$manager->getList2("select ville,nompays from pays,utilisateur where idpays_pays=idpays and idutilisateur=?",$rowResult[0]['idutilisateur']);    
$villePays = $arrayvillepays[0]['ville'].', '.$arrayvillepays[0]['nompays'];
//collaborator
$s_Collaborator='';
$_acolaborator = $manager->getList2("select centralepartenaireprojet,partenaire1 from projet where idprojet=?",$idprojet);
$s_Collaborator=$_acolaborator[0]['centralepartenaireprojet'].' '.$_acolaborator[0]['partenaire1'].',';
if(!empty($_acolaborator)){
    $arraycollaborator = $manager->getList2("select nomlaboentreprise from partenaireprojet,projetpartenaire where idpartenaire_partenaireprojet= idpartenaire and idprojet_projet=?",$idprojet);
    $nbarraycollaborator = count($arraycollaborator);
    for($i=0;$i<$nbarraycollaborator;$i++){
        $s_Collaborator.=$arraycollaborator[$i]['nomlaboentreprise'].', ';
    }
}
$s_collaborator=substr($s_Collaborator,0,-2);

$Thematics = $manager->getSingle2("SELECT libellethematiqueen FROM projet,thematique WHERE idthematique=idthematique_thematique and idprojet =?",$idprojet);
if($Thematics=='Others'){
    $Thematics = $manager->getSingle2("SELECT libelleautrethematique FROM autrethematique,projet WHERE idautrethematique_autrethematique=idautrethematique and idprojet =?",$idprojet);
}
if(!empty($rowModif[0]['datedebutprojet'])){
    $Startingdate=$rowModif[0]['datedebutprojet'];
}else{
    $Startingdate=date("m,d,Y");
}
//RESSOURCE
$s_ressource='';
$arrayresssource = $manager->getList2("select libelleressourceen from ressource, ressourceprojet where idressource_ressource = idressource and idprojet_projet=?",$idprojet);
$nbarrayresssource = count($arrayresssource);
for($i=0;$i<$nbarrayresssource;$i++){
    $s_ressource.=$arrayresssource[$i]['libelleressourceen'].',';
}
$Technicalwork = substr($s_ressource,0,-1);
$arrayrapport= $manager->getList2("select * from rapport where idprojet=?",$idprojet);

if(!empty($arrayrapport[0]['logo'])){
    $logo = $arrayrapport[0]['logo'];
}
if(!empty($arrayrapport[0]['figure'])){
    $figure = $arrayrapport[0]['figure'];
}
    if(!empty($arrayrapport[0]['valorization'])){
    $valorisation =removeDoubleQuote( $arrayrapport[0]['valorization']);
}
if(!empty($arrayrapport[0]['results'])){
    $results=removeDoubleQuote($arrayrapport[0]['results']);
}
if(!empty($arrayrapport[0]['entity'])){
    $entity=removeDoubleQuote($arrayrapport[0]['entity']);
}else{
   $entity=$entityprojet;
}

if(!empty($arrayrapport[0]['title'])){
    $title=stripslashes(removeDoubleQuote($arrayrapport[0]['title']));
}
if(!empty($arrayrapport[0]['author'])){
    $author=removeDoubleQuote($arrayrapport[0]['author']);
}else{
    $author=removeDoubleQuote($demandeur);
}

if(!empty($arrayrapport[0]['villepays'])){
    $villepays=removeDoubleQuote($arrayrapport[0]['villepays']);
}else{
    $villepays=removeDoubleQuote($villePays);
}
if(!empty($arrayrapport[0]['instituteinterest'])){
    $instituteinterest=removeDoubleQuote($arrayrapport[0]['instituteinterest']);
}else{
    $instituteinterest='';
}
if(!empty($arrayrapport[0]['fundingsource'])){
   $fundingsource=removeDoubleQuote($arrayrapport[0]['fundingsource']);
}else{
      $fundingsource=removeDoubleQuote($s_Sourcefinancement);
}
if(!empty($arrayrapport[0]['collaborator'])){
   $collaborator=removeDoubleQuote($arrayrapport[0]['collaborator']);
}else{
      $collaborator=removeDoubleQuote($s_collaborator);
}
if(!empty($arrayrapport[0]['thematics'])){
   $thematics=$arrayrapport[0]['thematics'];
}else{
      $thematics=$Thematics;
}
if(!empty($arrayrapport[0]['startingdate'])){
   $startingdate=$arrayrapport[0]['startingdate'];
}elseif(!empty($Startingdate)){
      $startingdate=$Startingdate;
}else{
     $startingdate=date("m,d,Y");
}
if(!empty($arrayrapport[0]['objectif'])){
   $contexteobjectif=removeDoubleQuote($arrayrapport[0]['objectif']);
}else{
      $contexteobjectif=removeDoubleQuote($Contexteobjectif);
}
if(!empty($arrayrapport[0]['technologicalwc'])){
   $technicalwork=removeDoubleQuote($arrayrapport[0]['technologicalwc']);
}else{
      $technicalwork=removeDoubleQuote($Technicalwork);
}
if(!empty($arrayrapport[0]['logocentrale'])){
   $logocentralerattachement=$arrayrapport[0]['logocentrale'];
}else{
      $logocentralerattachement='';
}
$logocentrale=$manager->getSingle2("select adresselogcentrale from sitewebapplication where refsiteweb = (SELECT libellecentrale from centrale,concerne where idcentrale_centrale=idcentrale and idprojet_projet=?)", $idprojet);
 
if(isset($_GET['statut'])){
    $idstatut = $_GET['statut'];
}else{
    $idstatut = $manager->getSingle2("SELECT  idstatutprojet_statutprojet FROM concerne,projet WHERE idprojet_projet = idprojet and idprojet = ?",$idprojet);
} 
?>
<script src="<?php echo '/'.REPERTOIRE; ?>/js/jquery-1.8.0.min.js"></script>  
<form name="rapport" data-dojo-type="dijit/form/Form" id="rapport"   method="post" 
      action="<?php echo '/'.REPERTOIRE; ?>/modifBase/updateRapport.php?lang=<?php echo $lang; ?>&idprojet=<?php echo $idprojet ;?>&idstatut=<?php echo $idstatut ;?>" enctype="multipart/form-data" >
    <input name="page_precedente" type="hidden" value="<?php echo basename(__FILE__) ; ?>">
    <script type="dojo/on" data-dojo-event="submit">
                var nbcontexte = strip_tags(trim(dojo.byId("contexteobjectif").value),'').length;
                var nbresults = strip_tags(trim(dijit.byId("results").value),'').length;
                var nbvalorization = strip_tags(trim(dijit.byId("valorization").value),'').length;
                var nblegend = strip_tags(trim(dijit.byId("legend").value),'').length;
                var nberrImage = strip_tags(trim(document.getElementById("errImg").value),'').length;
                var errextension =document.getElementById("errExtension");
                var errsizelogo =document.getElementById("errSize");
                var errSizeFigure = document.getElementById("errSizeFigure");
                var errExtensionFigure = document.getElementById("errExtensionFigure");
                if(dijit.byId('fileName')){
                    var nbFilename = (dijit.byId('fileName').value).length;
                }else{
                    var nbFilename = '';
                }
                if(document.getElementById('inputFigure')){
                    var nbInputFigure = (document.getElementById('inputFigure').value).length;
                }else{
                    var nbInputFigure = '';
                }                        
                if(nbcontexte>1200){
                    alert("<?php echo 'The number of characters for the Project objectives  must be less than 1200, please correct'; ?>");
                    return false;                    
                    exit();                
                }else if(nbresults>1200){
                    alert("<?php echo 'The number of characters for the Rsults must be less than 1200, please correct'; ?>");
                    return false;                    
                    exit();                
                }else if(nbvalorization>820){
                    alert("<?php echo 'The number of characters for the Valorization must be less than 800, please correct'; ?>");
                    return false;                    
                    exit();                
                }else if(nblegend>120){
                    alert("<?php echo 'The number of characters for the Caption must be less than 110, please correct'; ?>");
                    return false;                    
                    exit();                
                }else if(nberrImage>0){
                    alert("<?php echo 'Error on logo!' ?>");
                    return false;                    
                    exit();                
                }else if(errextension){
                    alert("<?php echo 'Error on logo!' ?>");
                    return false;                    
                    exit();                
                }else if(errsizelogo){
                    alert("<?php echo 'Error on logo!' ?>");
                    return false;                    
                    exit();                
                }else if(errExtensionFigure){
                    alert("<?php echo 'Error on Figure!' ?>");
                    return false;                    
                    exit();                
                }else if(errSizeFigure){
                    alert("<?php echo 'Error on Figure!' ?>");
                    return false;                    
                    exit();                
                }else if(nbFilename>0 && !nbInputFigure){
                    alert("<?php echo 'You must click on validate before!' ?>");
                    return false;                    
                    exit();                
                }else if (this.validate()){
                    return true;
                }else{
                    alert("<?php echo TXT_ERR; ?>");
                    return false;
                }
</script>
<?php 
        if(isset($_GET['erreuruploadsizerapport'])) {
            $idrapport = $manager->getSingle2("select idrapport from rapport where idprojet=?",$idprojet);
            $rapportfigure = new Rapportfigure($idrapport,'');//effacement de l'attachement
            $manager->updateRapportfigure($rapportfigure,$idrapport);
            echo "<tr  id='msgerrdescriptechno'><td><fieldset class='msgerrdescriptechno' ><legend>ERROR!</legend>The size of the logos must not be above 800px by 630px and 250Ko. Other data has been saved</fieldset></td></tr>";
        }elseif(isset($_GET['erreuruploadsextension'])) {
            $idrapport = $manager->getSingle2("select idrapport from rapport where idprojet=?",$idprojet);
            $rapportfigure = new Rapportfigure($idrapport,'');//effacement de l'attachement
            $manager->updateRapportfigure($rapportfigure,$idrapport);
            echo "<tr  id='msgerrdescriptechno'><td><fieldset class='msgerrdescriptechno' ><legend>ERROR!</legend>The extension of the figure and the logos authorized are jpg,jpeg or png. Other data has been saved</fieldset></td></tr>";
        }   
    ?>                
        
    
    <input type="hidden" id="contexteobjectif" name="contexteobjectif"  >
    <input type="hidden" id="resultats" name="resultats" >
    <input type="hidden" id="valorisation" name="valorisation" >
    <input type="hidden" id="legende" name="legende" >
    <input type="hidden" id="errImg" value="" >    
    <input type="hidden" id="restaureLogoCentrale" name="restaureLogoCentrale" value="" >    
    <input type="hidden" id="restaureLogo" name="restaureLogo" value="" >    
    <input type="hidden"  name='idprojet' value='<?php echo $idprojet; ?>' >
    <div data-dojo-type="dijit/Dialog" data-dojo-id="rep" id ='rep' title="" style="width: 380px;margin-left: 20px;"  >
        <table class="dijitDialogPaneContentArea">
            <tr>
                <td><button type="submit" data-dojo-type="dijit/form/Button"  id="submitOui" data-dojo-props="onClick:function(){confirm.show();}">
                        <?php echo TXT_OUI; ?></button></td>
                <td><button type="submit" data-dojo-type="dijit/form/Button"  id="submitNon" data-dojo-props="onClick:function(){rep.hide();}">
                        <?php echo TXT_NON; ?></button></td>
                <td><button data-dojo-type="dijit/form/Button" type="submit" data-dojo-props="onClick:function(){rep.hide();}" id="cancel"><?php echo TXT_ANNULE; ?></button></td>
            </tr>
        </table>
    </div>    
    <?php 
        $idrapport = $manager->getSingle2("select idrapport from rapport where idprojet=?",$idprojet);
        if(!empty($idrapport)){        
    ?>
    <div data-dojo-type="dijit/Dialog" data-dojo-id="confirm" title="<?php echo 'Attention you are going to delete the report, you confirm?'; ?>" data-dojo-props="iconClass:'dijitEditorIcon dijitEditorIconCut', showLabel: true"
     style="width: 380px;margin-left: 20px;   ">
    <table class="dijitDialogPaneContentArea" >
        <tr>
            <td><button type="submit" data-dojo-type="dijit/form/Button"   id="submitYes" 
                        onclick="window.location.replace('<?php echo '/'.REPERTOIRE;?>/delete_report/<?php echo $lang.'/'.$idrapport.'/'.$numProjet.'/'.$idstatut;?>')">
                    <?php echo 'Yes'; ?></button></td>
            <td><button type="submit" data-dojo-type="dijit/form/Button"  id="submitNo" data-dojo-props="onClick:function(){confirm.hide();}
                        ">
                    <?php echo 'No'; ?></button></td>
            <td><button data-dojo-type="dijit/form/Button" type="submit" data-dojo-props="onClick:function(){confirm.hide();}" id="efface"><?php echo 'Cancel'; ?></button></td>
        </tr>
    </table>
</div>
    <table border="0" cellspacing="0" cellpadding="0">
        <tr>
            <td style="width:50%"></td>
            <td style="background: none no-repeat scroll 15px 50% #529ab7;color: white;font-size: 0.9em;margin-top: 1px;padding: 10px;text-align: center;width: 300px;"><?php echo 'The report must be written in English';?></td>            
        </tr>
</table>
<table style="width:250px;float: right;margin-right: 20px;border-color: #5D8BA2;">
    <tr>
        <td>
        <div style='padding-left: 200px;' >
            <a href="<?php echo '/'.REPERTOIRE.'/pdf_report/'.$lang.'/'.$idprojet; ?>" target="_blank" title="<?php echo 'Create the report' ;?>"><img src="<?php echo '/'.REPERTOIRE; ?>/styles/img/pdficon.png"  ></a>
        </div>            
        <div style='padding-left: 208px;margin-top:10px' >
            <a href="#"  title="<?php echo 'Delete the Report'; ?>" onclick="confirm.show()"><img src="<?php echo '/'.REPERTOIRE; ?>/styles/img/trash.png"  ></a>
        </div>
        </td>            
    </tr>
</table> 
    <?php }else{ ?>
    <table style="width:250px;margin-right: 20px;margin-top:30px;border-color: #5D8BA2;">
        <tr>
            <td>
                <fieldset style='   border: 1px solid darkblue;border-radius: 5px;color: darkblue;font-family: verdana;margin-top: -30px;padding-top: 4px;padding-bottom: 6px;padding-left: 15px;padding-right: 15px;text-align: center;width: 995px;'>Complete in English and save the report before generating the pdf file </fieldset>
            </td>
        <tr>
            
        <tr>    
            <?php if(isset($_GET['delete'])){?>
            <td>
                <div style='color: red;font-family: verdana;margin-top: 10px;text-align: center;width: 995px;'><?php echo $_SESSION['messageDelete']; ?></div>
            </td>
            <?php }?>
        </tr>
    </table>
        <?php } ?>
        <script>
            function updateInput(id,id1){
                if(dijit.byId(id1)){
                    dijit.byId(id).set("value",dijit.byId(id1).get('value'));
                }else if(document.getElementById(id1)) {
                    dijit.byId(id).set("value",document.getElementById(id1).value);
                }
            }
        </script>
    <table>
        <tr>
            <td>
                <label for="titre" style="width: 100px;margin-bottom: 10px;float: left;margin-left: 20px;font-weight:bold;margin-top:30px"><?php echo 'Title :'; ?></label>
                <input id="titre" value="<?php if(!empty($title)){echo $title;}else{echo $titre;} ?>"  type="text"  data-dojo-type="dijit/form/ValidationTextBox" name= "titre" 
                       maxlength="300" style=";margin-left: 20px;margin-top:30px;margin-bottom: 10px;width: 566px"  ></td>
            <td>
                <a href="javascript:updateInput('titre','titreProjet')"  title="<?php echo 'Update the title from the project' ;?>">
                    <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-left: 5px;margin-top: 20px"/>
                </a>
            </td>
        </tr>
        <tr>
            <td>
                <label for="author" style="width: 100px;margin-bottom: 10px;float: left;margin-left: 20px;font-weight:bold"><?php echo 'Authors : '?></label>
                <input id="author" value="<?php echo $author; ?>"  type="text" maxlength="60"   data-dojo-type="dijit/form/ValidationTextBox" name= "author" 
                           data-dojo-props="regExp:'[a-zA-ZàáâäãåèéêëìíîïòóôöõøùúûüÿýñçčšžÀÁÂÄÃÅÈÉÊËÌÍÎÏÒÓÔÖÕØÙÚÛÜŸÝÑßÇŒÆČŠŽ∂ð%&:0-9\042\'()+/_ ,.-]+'"	
                           style="margin-left: 20px;float: left;margin-bottom: 10px;width:565px" data-dojo-invalidMessage="<?php echo TXT_ERRSTRING ;?>" />
            </td>
            <td>
                <a href="javascript:updateInput('author','demandeur')"  title="<?php echo 'Update the Author from the project' ;?>">
                    <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-left: 5px;margin-bottom: 5px"/>
                </a>
            </td>
        </tr>
    </table>
        <table>
        <tr>
            <td>
                <label for="entity" style="width: 150px;margin-bottom: 10px;float: left;margin-left: 20px;font-weight:bold"><?php echo 'Entity,CNRS code : ' ?></label>
                <input id="entity" value="<?php echo $entity; ?>"  type="text"  maxlength="75"  data-dojo-type="dijit/form/ValidationTextBox" name= "entity" 
                           data-dojo-props="regExp:'[a-zA-ZàáâäãåèéêëìíîïòóôöõøùúûüÿýñçčšžÀÁÂÄÃÅÈÉÊËÌÍÎÏÒÓÔÖÕØÙÚÛÜŸÝÑßÇŒÆČŠŽ∂ð%&:0-9\042\'()+/_ ,.-]+'"	
                           style="margin-left: 20px;float: left;margin-bottom: 10px;width:565px" data-dojo-invalidMessage="<?php echo TXT_ERRSTRING ;?>"
                             />
            </td>
            <td>
                <a href="javascript:updateInput('entity','entityCNRSCode')"  title="<?php echo 'Update the Entity,CNRS Code from the project' ;?>">
                    <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-left: 5px;margin-bottom: 5px"/>
                </a>
            </td>
        </tr>
        <tr>
            <td>
                <label for="villepays" style="width: 150px;margin-bottom: 10px;float: left;margin-left: 20px;font-weight:bold"><?php echo 'Town, Country : ' ?></label>
                <input id="villepays" value="<?php echo $villepays; ?>"  type="text" maxlength="60"   data-dojo-type="dijit/form/ValidationTextBox" name= "villepays" 
                           data-dojo-props="regExp:'[a-zA-ZàáâäãåèéêëìíîïòóôöõøùúûüÿýñçčšžÀÁÂÄÃÅÈÉÊËÌÍÎÏÒÓÔÖÕØÙÚÛÜŸÝÑßÇŒÆČŠŽ∂ð%&:0-9\042\'()+/_ ,.-]+'"	
                           style="margin-left: 20px;float: left;margin-bottom: 10px;width:566px" data-dojo-invalidMessage="<?php echo TXT_ERRSTRING ;?>" />
            </td>
             <td>
                <a href="javascript:updateInput('villepays','townCountry')"  title="<?php echo 'Update the Entity,CNRS Code from the project' ;?>">
                    <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-left: 5px;margin-bottom: 5px"/>
                </a>
            </td>
        </tr>
        <tr>
            <td>
                <label for="instituteinterest" style="width: 220px;margin-bottom: 10px;float: left;margin-left: 20px;font-weight:bold"><?php echo 'CNRS institute of interest : ' ?></label>
                <input id="instituteinterest" value="<?php echo $instituteinterest;?>"  type="text" maxlength="50"   data-dojo-type="dijit/form/ValidationTextBox" name= "instituteinterest" 
                           data-dojo-props="regExp:'[a-zA-ZàáâäãåèéêëìíîïòóôöõøùúûüÿýñçčšžÀÁÂÄÃÅÈÉÊËÌÍÎÏÒÓÔÖÕØÙÚÛÜŸÝÑßÇŒÆČŠŽ∂ð%&:0-9\042\'()+/_ ,.-]+'"	
                           style="margin-left: 20px;float: left;margin-bottom: 10px;width:496px" 
                           data-dojo-invalidMessage="<?php echo TXT_ERRSTRING ;?>" />
            </td>
        </tr>
        </table>
    <table>
        <tr>
            <td>
                <label for="fundingsource" style="width: 140px;margin-bottom: 10px;float: left;margin-left: 20px;font-weight:bold"><?php echo 'Funding source : ' ?></label>
                <input id="fundingsource" value="<?php echo $fundingsource; ?>"  type="text" maxlength="80"   data-dojo-type="dijit/form/ValidationTextBox" name= "fundingsource" 
                           data-dojo-props="regExp:'[a-zA-ZàáâäãåèéêëìíîïòóôöõøùúûüÿýñçčšžÀÁÂÄÃÅÈÉÊËÌÍÎÏÒÓÔÖÕØÙÚÛÜŸÝÑßÇŒÆČŠŽ∂ð%&:0-9\042\'()+/_ ,.-]+'"	
                           style="margin-left: 20px;float: right;width:810px;margin-bottom: 10px" data-dojo-invalidMessage="<?php echo TXT_ERRSTRING ;?>" />
            </td>
            <td>
                <a href="javascript:updateInput('fundingsource','sourceFinancement')"  title="<?php echo 'Update the Funding source from the project' ;?>">
                    <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-left: 5px;margin-bottom: 5px"/>
                </a>
            </td>
        </tr>
        <tr>
    </table>    
    <table>
        <tr>
            <td>
                <label for="collaborator" style="width: 350px;margin-bottom: 10px;float: left;margin-left: 20px;font-weight:bold"><?php echo 'Collaborators in the project or consortium : ' ?></label>
                <input id="collaborator" value="<?php echo $collaborator; ?>"  type="text"    data-dojo-type="dijit/form/ValidationTextBox" name= "collaborator" maxlength="64"
                           data-dojo-props="regExp:'[a-zA-ZàáâäãåèéêëìíîïòóôöõøùúûüÿýñçčšžÀÁÂÄÃÅÈÉÊËÌÍÎÏÒÓÔÖÕØÙÚÛÜŸÝÑßÇŒÆČŠŽ∂ð%&:0-9\042\'()+/_ ,.-]+'"	
                           style="margin-left: 20px;float: right;width:600px;margin-bottom: 10px" data-dojo-invalidMessage="<?php echo TXT_ERRSTRING ;?>" />
            </td>
            <td>
                <a href="javascript:updateInput('collaborator','collaborators')"  title="<?php echo 'Update the Collaborators from the project' ;?>">
                    <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-left: 5px;margin-bottom: 5px"/>
                </a>
            </td>
        </tr>
    </table>
    <hr>
    <table>
        <tr>
              <td style="width: 25%"></td>
            <td style="background: none no-repeat scroll 15px 50% #529ab7;color: white;font-size: 0.9em;margin-top: 1px;padding: 10px;text-align: center;width: 625px;"><?php echo 'size,height no limit, weight = 2048 Ko (2Mo), extensions = jpg,jpeg or png ';?></td>
        </tr>
    </table>
    <?php
        //CALCUL DES DIMENSIONS DU LOGO                
        if(isset($logocentralerattachement)&&!empty($logocentralerattachement)){            
            $arrayInfoImg0 =getimagesize("uploadlogo/".nomFichierValidesansAccent($logocentralerattachement));
        }else{        
            $arrayInfoImg0 =getimagesize($logocentrale);
        }
        $w=sizeLogo($arrayInfoImg0,80);        
        $width0 = $w[0];        
        $height0 = $w[1];

    $idprojet = $manager->getSingle2("select idprojet from projet where numero =?",$_SESSION['numProjet']);
    $src = $manager->getSingle2("select adresselogcentrale from sitewebapplication where refsiteweb = (SELECT libellecentrale from centrale,concerne where idcentrale_centrale=idcentrale and idprojet_projet=?)", $idprojet);
    $arrayInfoImg = getimagesize($src);    
    $t =sizeLogo($arrayInfoImg,80);
    $width = $t[0];
    $height = $t[1];

?>
<script>
    document.getElementById('restaureLogoCentrale').value='';     
    function deleteSource(){
        if(document.getElementById("imagLogCentrale")){
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("imagLogCentrale");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("ratio");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("logocentrale");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("cibleLogocentrale");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("errSize");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("errExtension");});           
        }
    }
    function deleteSource1(){
        if(document.getElementById("imagLog")){
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("imagLog");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("logo");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("cibleLogo");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("errSize");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("errExtension");});
            require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("ratio1");});
        }
        
    }
    function restoreOriginale(){
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("imagLogCentrale");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("logocentrale");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("cibleLogocentrale");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("errSize");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("errExtension");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("ratio");});
        require(["dojo/dom"], function(dom){dom.byId("cibleOriginal").innerHTML = "<img src='<?php echo '/' . REPERTOIRE .  '/' . $src; ?>' width='<?php echo $width; ?>' height='<?php echo $height; ?>'  />";});
        document.getElementById('restaureLogoCentrale').value='ok';
        
    }
    document.getElementById('restaureLogo').value='';
    function restoreOriginale2(){
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("imagLog");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("logo");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("cibleLogo");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("errSize");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("errExtension");});
        require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("ratio1");});
        require(["dojo/dom"], function(dom){dom.byId("cibleOriginal1").innerHTML = "<img src='<?php echo '/' . REPERTOIRE .  '/' . $src; ?>' width='<?php echo $width; ?>' height='<?php echo $height; ?>'  />";});
        document.getElementById('restaureLogo').value='ok';
        
    }
</script>    
    <!-- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
    <!--                                                                        BTR CENTRE LOGO                                                                                                         -->
    <!-- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
    
    <table border="0" cellspacing="0" cellpadding="0" style="" >
        <tr>
            <td>
                <div style="font-size: 0.9em;font-style: italic;margin-left: 171px;margin-top: 5px;">You must click on Browse.. to select a file and click on validate to download it before saving the report </div>
            </td>
        </tr>
        <tr><td><label  style="font-weight:bold;margin-top:20px;margin-left:40px"><?php echo 'BTR Centre logo :' ?></label></td></tr>
    <tr>
        <?php if(isset($logocentralerattachement)&&!empty($logocentralerattachement)){?>
        <td style="height: 49px;padding-left: 36px">
            <input name='filelogocentrale' type='file' id='filelogocentrale'   size='20' style="display: none "  
                   onchange="dijit.byId('fileNameLogoCentrale').set('value',document.getElementById('filelogocentrale').files[0].name);">
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){document.getElementById('filelogocentrale').click();}"><?php echo 'Browse..'; ?></button>
            <input type="text" data-dojo-type="dijit/form/ValidationTextBox" id='fileNameLogoCentrale' readonly="true">            
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){uploadLogoCentrale();}" style="margin-left: 25px;"><?php echo 'Validate'; ?></button>
            <a title="restore the logo  from the original" href="javascript:restoreOriginale()"><img width="16" height="16" style="margin-left: 5px;margin-top: 20px" src="/projet-dev/styles/img/update.png"></a>
        </td>
    </tr>
    <tr style="float: left;" id="imgLogCentrale">
        <td style="float: left;margin-left:40px;margin-top: 10px">
            <div id="cibleOriginal"></div>
            <img id="imagLogCentrale" src=" <?php echo  '/' . REPERTOIRE . '/uploadlogo/' . nomFichierValidesansAccent($logocentralerattachement) ?>" width='<?php echo $width0; ?>' height='<?php echo $height0; ?>' style="margin-bottom: 5px;margin-top: 15px"></td>
    </tr>
    <tr><td><div id="ratio" style="margin-left:40px"><?php echo 'ratio: 1 : '.round($height0/$width0,2); ?></div></td></tr>

        <?php }else{?>
    <tr>   
        <td>
            <input name='filelogocentrale' type='file' id='filelogocentrale'  size='20' style="display: none " onchange="dijit.byId('fileNameLogoCentrale').set('value',document.getElementById('filelogocentrale').files[0].name);">
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){document.getElementById('filelogocentrale').click();}" style="margin-left:40px"><?php echo 'Browse..'; ?></button>
            <input type="text" data-dojo-type="dijit/form/ValidationTextBox" id='fileNameLogoCentrale' readonly="true">
            <a title="restore the logo  from the original" href="javascript:restoreOriginale()"><img width="16" height="16" style="margin-left: 5px;margin-top: 20px" src="/projet-dev/styles/img/update.png"></a>
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){uploadLogoCentrale();}" style="margin-left: 25px;"><?php echo 'Validate'; ?></button> 
            <div id="cibleLogocentrale" style="width: 125px;height:125px;margin-left:40px;margin-top:20px"><img src='<?php echo "/".REPERTOIRE."/".$logocentrale;?>' width="<?php echo $width; ?>" height="<?php echo $height; ?>"/><br></div>
        </td>
        
    </tr>
    <tr style="float: left;">
        <td style="float: left;margin-left:40px;margin-top: 10px">
            <div id="cibleOriginal"></div>         
    </tr>
    <?php }?>
    <tr><td><progress id="progressBar2" value="0" max="100" style="width:358px;margin-left:40px;height: 20px;visibility: hidden;" ></progress>
            <div id="status2" style="margin-left:40px;"></div><div id="status_bytes2" style="padding-right: 120px;margin-top: 10px;margin-left: 40px"></div>
        </td></tr>
</table>        
    <div style="width: 800px;margin-left:130px"><hr /></div>
    <!-- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
    <!--                                                                         ENTITY LOGO                                                                                                            -->
    <!-- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
    <table border="0" cellspacing="0" cellpadding="0" style="" ><tr><td><label  style="font-weight:bold;margin-top:20px;margin-left:40px"><?php echo 'Entity logo : ' ?></label></td></tr>
    <tr>
        <?php if(isset($logo)&&!empty($logo)){ ?>
        <td style="height: 49px;padding-left: 36px">
            <input name='filelogo' type='file' id='filelogo'   size='20' style="display: none "          
                   onchange="dijit.byId('fileNameLogo').set('value',document.getElementById('filelogo').files[0].name);">
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){document.getElementById('filelogo').click();}"><?php echo 'Browse..'; ?></button>
            <input type="text" data-dojo-type="dijit/form/ValidationTextBox" id='fileNameLogo' readonly="true">            
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){uploadLogo();}" style="margin-left: 25px;"><?php echo 'Validate'; ?></button>
            <a title="restore the logo  from the original" href="javascript:restoreOriginale2()"><img width="16" height="16" style="margin-left: 5px;margin-top: 20px" src="/projet-dev/styles/img/update.png"></a>
        </td>
    </tr>
    <tr style="float: left;">
        <td style="float: left;margin-left:40px;margin-top: 10px">
            <div id="cibleOriginal1"></div>
            <?php 
                $arrayInfoImg = getimagesize('uploadlogo/'.$logo);    
                $u =sizeLogo($arrayInfoImg,80); 
                $width = $u[0];
                $height = $u[1];
            ?>
            <img id="imagLog" src=" <?php echo  '/' . REPERTOIRE . '/uploadlogo/' . nomFichierValidesansAccent($logo) ?>" width='<?php echo $width; ?>' height='<?php echo $height; ?>' style="margin-bottom: 5px;margin-top: 15px"></td>
    </tr>
    <tr><td><div id="ratio1"  style="margin-left:40px"><?php echo 'ratio: 1 : '.round($height/$width,2); ?></div></td></tr>

        <?php }else{?>
    <tr>   
        <td>
            <input name='filelogo' type='file' id='filelogo'  size='20' style="display: none " onchange="dijit.byId('fileNameLogo').set('value',document.getElementById('filelogo').files[0].name);">
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){document.getElementById('filelogo').click();}" style="margin-left:40px"><?php echo 'Browse..'; ?></button>
            <input type="text" data-dojo-type="dijit/form/ValidationTextBox" id='fileNameLogo' readonly="true">
            <a title="restore the logo  from the original" href="javascript:restoreOriginale2()"><img width="16" height="16" style="margin-left: 5px;margin-top: 20px" src="/projet-dev/styles/img/update.png"></a>
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){uploadLogo();}" style="margin-left: 25px;"><?php echo 'Validate'; ?></button> 
            <div id="cibleLogo" style="width: 125px;height:125px;margin-left:40px;margin-top:20px"><img src='<?php echo "/".REPERTOIRE."/".$logocentrale;?>' width="<?php echo $width; ?>" height="<?php echo $height; ?>"/><br></div>
        </td>
        
    </tr>
    <tr style="float: left;">
        <td style="float: left;margin-left:40px;margin-top: 10px">
            <div id="cibleOriginal1"></div>         
    </tr>
    <?php }?>
    <tr><td><progress id="progressBar1" value="0" max="100" style="width:358px;margin-left:40px;height: 20px;visibility: hidden;" ></progress>
            <div id="status1" style="margin-left:40px;"></div><div id="status_bytes1" style="padding-right: 120px;margin-top: 10px;margin-left: 40px"></div>
        </td></tr>
</table>
    <!-- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
    <!--                                                                        END ENTITY LOGO                                                                                                            -->
    <!-- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
    <hr>
    <table>
        <tr>
            <td>
                <label for="thematics" style="width: 150px;margin-bottom: 10px;float: left;margin-left: 20px;font-weight:bold"><?php echo 'BTR Thematics: ' ?></label>
                <input id="thematics" value="<?php echo $thematics; ?>"  type="text" maxlength="600"   data-dojo-type="dijit/form/ValidationTextBox" name= "thematics" 
                           data-dojo-props="regExp:'[a-zA-ZàáâäãåèéêëìíîïòóôöõøùúûüÿýñçčšžÀÁÂÄÃÅÈÉÊËÌÍÎÏÒÓÔÖÕØÙÚÛÜŸÝÑßÇŒÆČŠŽ∂ð%&:0-9\042\'()+/_ ,.-]+'"	style="margin-left: 20px;float: right;width:270px" data-dojo-invalidMessage="<?php echo TXT_ERRSTRING ;?>" >
                </td>
                 <td>
                    <a href="javascript:updateInput('thematics','thematic')"  title="<?php echo 'Update the Thematics from the project' ;?>">
                        <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-left: 5px;"/>
                    </a>
                </td>
                <td>
                <label for="startingdate" style="width: 150px;margin-bottom: 10px;float: left;margin-left: 70px;font-weight:bold"><?php echo 'Starting date : ' ?></label>
                <input id="startingdate" value="<?php echo $startingdate; ?>"  type="text"   data-dojo-type="dijit/form/DateTextBox" name= "startingdate" data-dojo-style="margin-left: 20px;float: right;width:270px;margin-bottom: 10px"  >
            </td>
            <td>
                <a href="javascript:updateInput('startingdate','datedebutprojet')"  title="<?php echo 'Update the Starting date from the project' ;?>">
                    <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-left: 5px;"/>
                </a>
            </td>
        </tr>
    </table>
<table>
    <tr>
        
        <td><label for="contextObjectif" style="width: 160px;float: left;margin-left: 20px;font-weight:bold;padding: 10px"><?php echo 'Project objectives :' ?></label>
            <div  class="eraseDigitObj"><input type="button"  label="<?php echo 'Delete Project objectives' ;?>" data-dojo-type="dijit/form/Button" 
        data-dojo-props="onClick:function(){menuConfirmationEmptyTrash('repEmptyTrash',this.id)}" id='contextDialog' ></div>
            <a href="javascript:updateInput('contextObjectif','contexte')"  title="<?php echo 'Update the Project objectives from the project' ;?>">
            <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-top: 8px;"/>
            </a>
        </td>
    </tr>
    <tr>
    <td>
        <div id="contextObjectif" name="contextObjectif" style="width:1000px;margin-left:20px" ><p><?php echo $contexteobjectif;?></p></div></td>
    </tr>
    <tr><td><label id="cptcontexteobjectif" style="width:450px;color:#B71701;margin-left: 20px;margin-bottom: 10px; "></label></td></tr>
        <tr style="display: none;margin-left: 20px" id="msgerrcontextObjectif">
            <td>
                <fieldset class='msgerrcontexte' ><legend><?php echo TXT_INFO;?></legend>
                    <?php 	echo 'The number of characters must be less than 1200 , the above values ​​are not saved'.'<br>';?>
                </fieldset>
            </td>
        </tr>
</table>
<hr>
<table>
    <tr>
        <td>
            <label for="results" style="width: 120px;float: left;margin-left: 20px;font-weight:bold;"><?php echo 'Results :' ?></label>
            <div  class="eraseDigit">
                <input type="button"  label="<?php echo 'Delete Results' ;?>" data-dojo-type="dijit/form/Button" 
                data-dojo-props="onClick:function(){menuConfirmationEmptyTrash('repEmptyTrash',this.id)}" id='resultDialog'>                
            </div>
        </td>
    </tr>
    <tr><td><div id="results" name="results" style="width:1000px;margin-left: 20px" ><?php if(!empty($results)){echo $results;} ?></div></td></tr>
    <tr><td><label id="cptresultats" style="width:450px;color:#B71701;margin-left: 20px;margin-bottom: 10px; "></label></td></tr>
        <tr style="display: none;margin-left:20px" id="msgerrresults">
            <td>
                <fieldset class='msgerrcontexte' ><legend><?php echo TXT_INFO;?></legend>
                    <?php echo 'The number of characters must be less than 1200 , the above values ​​are not saved'.'<br>';?>
                </fieldset>
            </td>
        </tr>
</table>
<hr/>
<table>     
        <tr>              
              <td style="width: 25%"></td>
            <td style="background: none no-repeat scroll 15px 50% #529ab7;color: white;font-size: 0.9em;margin-top: 1px;padding: 10px;text-align: center;width: 655px;">
                <?php echo 'size,height no limit, weight = 4096 Ko (4Mo), extensions = jpg,jpeg or png';?>
            </td>
        </tr>
        <tr><td><label for="results" style="float: left;margin-left: 20px;font-weight:bold; width: 110px;margin-bottom: 10px">Figure :</label></td></tr>     
    </table>
<div style="font-size: 0.9em;font-style: italic;margin-bottom: 10px;margin-left: 20px;margin-top: -10px;">You must click on Browse.. to select a file and click on validate to download it before saving the report </div>
<?php 

if(isset($figure) && $figure!=''){             
    //CALCUL DES DIMENSIONS DE LA FIGURE
    $figure = nomFichierValidesansAccent($figure);
    $arrayInfoImg =getimagesize('uploadlogo/'.$figure);
    $v = sizeLogo($arrayInfoImg,160);
    $width = $v[0];
    $height = $v[1];    
}
?>
<script> 
    function setValue(id,id1,id2){
        dijit.byId(id).set('value',document.getElementById(id1).files[0].name);
        dojo.byId(id2).style.height = '2600px';
    }
</script>
<table border="0" cellspacing="0" cellpadding="0" style="width: 100%" lang="en">
    <tr>
        <?php if(isset($figure)){?>
        <td style="float: left">
            <input name='figure' type='file' id='file'   size='20' style="display: none " onchange="setValue('fileName','file','reportDiv') ;">
            <button type="button" data-dojo-type="dijit/form/Button" style="margin-left:20px"  data-dojo-props="onClick:function(){document.getElementById('file').click();}"><?php echo 'Browse..'; ?></button>
            <input type="text" data-dojo-type="dijit/form/ValidationTextBox" id='fileName' readonly="true">            
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){uploadFichier();}" style="margin-left: 25px;"><?php echo 'Validate'; ?></button>
        </td>
        </tr>
        <tr>
        <td style="float: left" id="cibleFigure">
            <img src=" <?php echo  '/' . REPERTOIRE . '/uploadlogo/' . nomFichierValidesansAccent($figure) ?>" width='<?php echo $width; ?>' height='<?php echo $height; ?>' style="margin-bottom: 5px;margin-top: 15px;margin-left:20px"></td>
        </tr><tr><td><div style="margin-left:20px" id='ratio2'><?php echo 'ratio: 1 : '.round($height/$width,2); ?></div></td></tr>
        <?php }else{?>
        <td>
            <input name='figure' type='file' id='file'  size='20' style="display: none " onchange="dijit.byId('fileName').set('value',document.getElementById('file').files[0].name);">
            <button type="button" data-dojo-type="dijit/form/Button"  style="margin-left:20px" data-dojo-props="onClick:function(){document.getElementById('file').click();}"><?php echo 'Browse..'; ?></button>
            <input type="text" data-dojo-type="dijit/form/ValidationTextBox" id='fileName' readonly="true">
            <button type="button" data-dojo-type="dijit/form/Button"   data-dojo-props="onClick:function(){uploadFichier();}" style="margin-left: 25px;"><?php echo 'Validate'; ?></button> 
        </td>
        <?php }?>         
    </tr>
    <tr><td><progress id="progressBar" value="0" max="100" style="width:290px;margin-left:20px;height: 20px;visibility: hidden;margin-top: 10px" ></progress>
            <div id="status" style="margin-left:20px;float: left;margin-top: 10px"></div><div id="status_bytes" style="padding-right: 240px;float: right;margin-top: 10px"></div>
        </td></tr>
</table>
<?php $legend = $manager->getSingle2("select legend from rapport where idrapport=?",$idrapport);?>
<table>
    <tr><td><label for="legend" style="font-weight:bold;width: 1000px;margin-left:20px"><?php echo 'Caption :' ?></label>
        <div  class="eraseDigit">
                <input type="button"  label="<?php echo 'Delete Caption' ;?>" data-dojo-type="dijit/form/Button" 
                data-dojo-props="onClick:function(){menuConfirmationEmptyTrash('repEmptyTrash',this.id)}" id="captionDialog">
            </div>
        </td></tr>
    <tr><td><div id="legend" name="legend" style="margin-left:20px" ><?php if(!empty($legend)){echo stripslashes(removeDoubleQuote($legend));} ?></div></td></tr>    
    <tr><td><label id="cptlegend" style="width:450px;color:#B71701;margin-left: 20px;margin-bottom: 10px; "></label></td></tr>
        <tr style="display: none;margin-left:20px" id="msgerrlegend">
            <td>
                <fieldset class='msgerrcontexte' ><legend><?php echo TXT_INFO;?></legend>
                    <?php  echo 'The number of characters must be less than 115 , the above values ​​are not saved'.'<br>';?>
                </fieldset>
            </td>
        </tr>   
    
</table>

<hr>
<table>
    <tr><td><label for="valorization" style="width: 1000px;float: left;margin-left: 20px;font-weight:bold;"><?php echo 'Valorization :' ?></label>
         <div  class="eraseDigitValorization">
                <input type="button"  label="<?php echo 'Delete Valorization' ;?>" data-dojo-type="dijit/form/Button" 
                data-dojo-props="onClick:function(){menuConfirmationEmptyTrash('repEmptyTrash',this.id)}" id="valorizationDialog">
            </div>
        </td></tr>
    <tr><td><div id="valorization" name="valorization" style="margin-left:20px" height="124" ><?php if(!empty($valorisation)){echo $valorisation;} ?></div></td></tr>
    <tr><td><label id="cptvalorisation" style="width:450px;color:#B71701;margin-left: 20px;margin-bottom: 10px; "></label></td></tr>
        <tr style="display: none;margin-left:20px" id="msgerrvalorization">
            <td>
                <fieldset class='msgerrcontexte' ><legend><?php echo TXT_INFO;?></legend>
                    <?php  echo 'The number of characters must be less than 800 , the above values ​​are not saved'.'<br>';?>
                </fieldset>
            </td>
        </tr>   
</table>
<hr>
<table>
    <tr>
        <td>
            <label for="technicalwork" style="width: 420px;float: left;margin-left: 20px;font-weight:bold;"><?php echo 'Technical work conducted in the Renatech network:' ?></label>
            <a href="javascript:updateInput('technicalwork','technicalworks')"  title="<?php echo 'Update the technicalwork from the project' ;?>">
                    <img src='<?php echo "/".REPERTOIRE; ?>/styles/img/update.png' height="16" width="16" style="margin-left: 5px;margin-bottom: 5px"/>
            </a>
        </td>
    </tr>
    <tr>
        <td>
            <input id="technicalwork" value="<?php echo $technicalwork; ?>"  type="text"   data-dojo-type="dijit/form/ValidationTextBox" name= "technicalwork"  maxlength="110"
                           data-dojo-props="regExp:'[a-zA-ZàáâäãåèéêëìíîïòóôöõøùúûüÿýñçčšžÀÁÂÄÃÅÈÉÊËÌÍÎÏÒÓÔÖÕØÙÚÛÜŸÝÑßÇŒÆČŠŽ∂ð%&:0-9\042\'()+/_ ,;.-]+'"	
                           style="margin-left: 20px;float: right;width:1000px" 
                           data-dojo-invalidMessage="<?php echo TXT_ERRSTRING ;?>" >
        </td>        
    </tr>
</table>
<table>
    <tr>
        <td>
            <input type="button"  label="<?php echo 'Save the report' ;?>" data-dojo-type="dijit/form/Button" data-dojo-props="onClick:function(){dijit.byId('rapport').submit()}" style="margin-top:30px;margin-left:20px">            
        </td>
    </tr>
</table>
<script>
function menuConfirmationEmptyTrash(e,id){
	dijit.byId(e).set('title', 'Thanks to confirm the deletion of the current input!');
        document.getElementById('currentInput').value=id;
	repEmptyTrash.show();
}

function deleteCurrentInput(){
    if( document.getElementById('currentInput').value === 'contextDialog' ){
        dijit.byId('contextObjectif').set('value','');
        document.getElementById('cptcontexteobjectif').innerHTML='Number of characters entered : '+0;
    }else if( document.getElementById('currentInput').value === 'resultDialog' ){
        dijit.byId('results').set('value','');
        document.getElementById('cptresultats').innerHTML='Number of characters entered : '+0;
    }else if( document.getElementById('currentInput').value === 'captionDialog' ){
        dijit.byId('legend').set('value','');
        document.getElementById('cptlegend').innerHTML='Number of characters entered : '+0;
    }else if( document.getElementById('currentInput').value === 'valorizationDialog' ){
        dijit.byId('valorization').set('value',''); 
        document.getElementById('cptvalorisation').innerHTML='Number of characters entered : '+0;
    }
}
</script>
<input type="text" value="" style="display: none" id='currentInput'/>
<div data-dojo-type="dijit/Dialog" data-dojo-id="repEmptyTrash" id ='repEmptyTrash'  title="<?php echo TXT_CONFIRMATIONDELPROJET; ?>" data-dojo-props="iconClass:'dijitEditorIcon dijitEditorIconCut', showLabel: true"
style="width: 400px;margin-left: 20px;   ">
<table class="dijitDialogPaneContentArea" >
   <tr>
	   <td><button type="submit" data-dojo-type="dijit/form/Button"   id="sOui" onclick="deleteCurrentInput()">Yes</button></td>
	   <td><button type="submit" data-dojo-type="dijit/form/Button"  id="sNon" data-dojo-props="onClick:function(){rep.hide();}">No</button></td>	   
   </tr>
</table>
</div>
<script>
    dojo.require("dojox.editor.plugins.SafePaste");
    require(["dojo/parser", "dijit/Editor"]);
    require(["dijit/Editor", "dojo/ready"], function(Editor, ready) {
        ready(function() {            
            new Editor({
                plugins: ["undo", "redo" ],
                height: "180px"
            }, "contextObjectif");
            new Editor({
                plugins: ["undo", "redo"],
                height: "180px"
            }, "results");
             new Editor({
                plugins: ["undo", "redo" ],
                extraPlugins:['safepaste'],
                height: "124px"
            }, "valorization");
             new Editor({
                plugins: ["undo", "redo"],
                height: "35px"
            }, "legend");
        });
        
        dojo.addOnLoad(function() {
            var editor1 = dijit.byId("contextObjectif");
            var editor2 = dijit.byId("results");
            var editor3 = dijit.byId("valorization");
            var editor4 = dijit.byId("legend");
            dojo.connect(editor1, "onChange", this, function(event) {
                dojo.byId("contexteobjectif").value = editor1.get("value");
            });
            dojo.connect(editor2, "onChange", this, function(event) {
                dojo.byId("resultats").value = editor2.get("value");
            });
            dojo.connect(editor3, "onChange", this, function(event) {
                dojo.byId("valorisation").value = editor3.get("value");
            });
            dojo.connect(editor4, "onChange", this, function(event) {
                dojo.byId("legende").value = editor4.get("value");
            });
                //CAS POUR CHROME
                dojo.byId("contexteobjectif").value = editor1.get("value");
                document.getElementById('cptcontexteobjectif').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>"+ strip_tags(trim(dojo.byId("contexteobjectif").value),'').length;
                dojo.byId("resultats").value = editor2.get("value");
                document.getElementById('cptresultats').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("resultats").value),'').length;
                dojo.byId("valorisation").value = editor3.get("value");
                document.getElementById('cptvalorisation').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("valorisation").value),'').length;
                dojo.byId("legend").value = editor4.get("value");
                document.getElementById('cptlegend').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("legend").value),'').length;
            /* --------------------------------------------------------------------------------------------------------------------
                                                                                LEGEND
             --------------------------------------------------------------------------------------------------------------------*/    
            dojo.connect(editor4, "onKeyPress", this, function(event) {
                dojo.byId("legende").value = editor4.get("value");
                document.getElementById('cptlegend').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("legende").value),'').length;
                if (trim(strip_tags(editor4.get("value")),'').length > 115) {    
                    document.getElementById('msgerrlegend').style.display = 'block';
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2900px";});
                } else {
                    document.getElementById('msgerrlegend').style.display = 'none';
                }                 
            });
            dojo.connect(editor4, "onSubmit", this, function(event) {
                dojo.byId("legende").value = editor4.get("value");
                document.getElementById('cptlegend').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("legende").value),'').length;
                if (trim(strip_tags(editor4.get("value")),'').length > 115) {    
                    document.getElementById('msgerrlegend').style.display = 'block';
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2900px";});
                } else {
                    document.getElementById('msgerrlegend').style.display = 'none';
                }                 
            });
            dojo.connect(editor4, "onBlur", this, function(event) {
                dojo.byId("legende").value = editor4.get("value");
                document.getElementById('cptlegend').innerHTML =  "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("legende").value),'').length;
                if (trim(strip_tags(editor4.get("value")),'').length > 115) {  
                    document.getElementById('msgerrlegend').style.display = 'block';
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2900px";});
                } else {
                    document.getElementById('msgerrlegend').style.display = 'none';
                }                
            });
            dojo.connect(editor4, "onClick", this, function(event) {
                dojo.byId("legende").value = editor4.get("value");
                document.getElementById('cptlegend').innerHTML =  "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("legende").value),'').length;
                if (trim(strip_tags(editor4.get("value")),'').length > 115) {  
                    document.getElementById('msgerrlegend').style.display = 'block';
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2900px";});
                } else {
                    document.getElementById('msgerrlegend').style.display = 'none';
                }            
            });
           dojo.connect(editor4, "onLoad", this, function(event) {
                dojo.byId("legende").value = editor4.get("value");
                document.getElementById('cptlegend').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("legende").value),'').length;                
            });	
            
            
            
        
            /* --------------------------------------------------------------------------------------------------------------------
                                                                                CONTEXTE
             --------------------------------------------------------------------------------------------------------------------*/
            dojo.connect(editor1, "onKeyPress", this, function(event) {
                dojo.byId("contexteobjectif").value = editor1.get("value");
                document.getElementById('cptcontexteobjectif').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("contexteobjectif").value),'').length;
                if (trim(strip_tags(editor1.get("value")),'').length > 1200) {    
                    document.getElementById('msgerrcontextObjectif').style.display = 'block';
                } else {
                    document.getElementById('msgerrcontextObjectif').style.display = 'none';
                }                 
            });
            dojo.connect(editor1, "onSubmit", this, function(event) {
                dojo.byId("contexteobjectif").value = editor1.get("value");
                document.getElementById('cptcontexteobjectif').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("contexteobjectif").value),'').length;
                if (trim(strip_tags(editor1.get("value")),'').length > 1200) {    
                    document.getElementById('msgerrcontextObjectif').style.display = 'block';
                } else {
                    document.getElementById('msgerrcontextObjectif').style.display = 'none';
                }                 
            });
            dojo.connect(editor1, "onBlur", this, function(event) {
                dojo.byId("contexteobjectif").value = editor1.get("value");
                document.getElementById('cptcontexteobjectif').innerHTML =  "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("contexteobjectif").value),'').length;
                if (trim(strip_tags(editor1.get("value")),'').length > 1200) {  
                    document.getElementById('msgerrcontextObjectif').style.display = 'block';
                } else {
                    document.getElementById('msgerrcontextObjectif').style.display = 'none';
                }                
            });
            dojo.connect(editor1, "onClick", this, function(event) {
                dojo.byId("contexteobjectif").value = editor1.get("value");
                document.getElementById('cptcontexteobjectif').innerHTML =  "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("contexteobjectif").value),'').length;
                if (trim(strip_tags(editor1.get("value")),'').length > 1200) {  
                    document.getElementById('msgerrcontextObjectif').style.display = 'block';
                } else {
                    document.getElementById('msgerrcontextObjectif').style.display = 'none';
                }            
            });
           dojo.connect(editor1, "onLoad", this, function(event) {
                dojo.byId("contexteobjectif").value = editor1.get("value");
                document.getElementById('cptcontexteobjectif').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("contexteobjectif").value),'').length;                
            });	
             /* --------------------------------------------------------------------------------------------------------------------
                                                                                RESULTS
             --------------------------------------------------------------------------------------------------------------------*/
            dojo.connect(editor2, "onKeyPress", this, function(event) {
                dojo.byId("resultats").value = editor2.get("value");
                document.getElementById('cptresultats').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("resultats").value),'').length;
                if (trim(strip_tags(editor2.get("value")),'').length > 1200) {
                    document.getElementById('msgerrresults').style.display = 'block';
                } else {
                    document.getElementById('msgerrresults').style.display = 'none';
                }                 
            });												
            dojo.connect(editor2, "onBlur", this, function(event) {
                dojo.byId("resultats").value = editor2.get("value");
                document.getElementById('cptresultats').innerHTML =  "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("resultats").value),'').length;
                if (trim(strip_tags(editor2.get("value")),'').length > 1200) {
                    document.getElementById('msgerrresults').style.display = 'block';
                } else {
                    document.getElementById('msgerrresults').style.display = 'none';
                }                
            });
            dojo.connect(editor2, "onClick", this, function(event) {
                dojo.byId("resultats").value = editor2.get("value");
                document.getElementById('cptresultats').innerHTML =  "<?php echo 'Number of characters entered '.' : '; ?>"+ strip_tags(trim(dojo.byId("resultats").value),'').length;
                if (trim(strip_tags(editor2.get("value")),'').length > 1200) {
                    document.getElementById('msgerrresults').style.display = 'block';
                } else {
                    document.getElementById('msgerrresults').style.display = 'none';
                }            
            });
           dojo.connect(editor2, "onLoad", this, function(event) {
                dojo.byId("resultats").value = editor2.get("value");
                document.getElementById('cptresultats').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("resultats").value),'').length;                
            });	
            /* --------------------------------------------------------------------------------------------------------------------
                                                                                VALORIZATION
             --------------------------------------------------------------------------------------------------------------------*/
            dojo.connect(editor3, "onKeyPress", this, function(event) {
                dojo.byId("valorisation").value = editor3.get("value");
                document.getElementById('cptvalorisation').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("valorisation").value),'').length;                
                if (trim(strip_tags(editor3.get("value")),'').length > 820) {
                    document.getElementById('msgerrvalorization').style.display = 'block';                    
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2900px";});
                } else {
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2600px";});
                    document.getElementById('msgerrvalorization').style.display = 'none';
                }                 
            });												
            dojo.connect(editor3, "onBlur", this, function(event) {
                dojo.byId("valorisation").value = editor3.get("value");
                document.getElementById('cptvalorisation').innerHTML =  "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("valorisation").value),'').length;
                if (trim(strip_tags(editor3.get("value")),'').length > 820) {
                    document.getElementById('msgerrvalorization').style.display = 'block';
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2900px";});
                } else {
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2600px";});
                    document.getElementById('msgerrvalorization').style.display = 'none';
                }                
            });
            dojo.connect(editor3, "onClick", this, function(event) {
                dojo.byId("valorisation").value = editor3.get("value");
                document.getElementById('cptvalorisation').innerHTML =  "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("valorisation").value),'').length;
                if (trim(stripTags(editor3.get("value"))).length > 820) {
                    document.getElementById('msgerrvalorization').style.display = 'block';
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2900px";});
                } else {
                    require(["dojo/dom"], function(dom){dom.byId("reportDiv").style.height = "2600px";}); 
                    document.getElementById('msgerrvalorization').style.display = 'none';
                }            
            });
           dojo.connect(editor3, "onLoad", this, function(event) {
                dojo.byId("valorisation").value = editor3.get("value");
                document.getElementById('cptvalorisation').innerHTML = "<?php echo 'Number of characters entered '.' : '; ?>" + strip_tags(trim(dojo.byId("valorisation").value),'').length;                
            });	
        });
    });
</script>
        <script>            
            function uploadFichier() {
                var file = document.getElementById('file').files[0];
                var data = new FormData();
                data.append('file', file);
                var ajax = new XMLHttpRequest();
                ajax.upload.addEventListener("progress", progressHandler, false);
                ajax.addEventListener("load", completeHandler, false);
                ajax.addEventListener("error", errorHandler, false);
                ajax.addEventListener("abort", abortHandler, false);
                ajax.open("POST", "<?php echo '/'.REPERTOIRE; ?>/rapport/uploadFigure.php");
                ajax.send(data);
            }
            function progressHandler(event) {
                document.getElementById('progressBar').style.visibility='visible';
                document.getElementById('status_bytes').innerHTML = event.loaded + ' bytes uploaded on ' + event.total;
                var pourcentage = (event.loaded / event.total) * 100;
                document.getElementById('progressBar').value = Math.round(pourcentage);
                document.getElementById('status').innerHTML = Math.round(pourcentage) + '% uploaded... Wait';
                require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("cibleFigure");});
                require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("ratio2");});
            }
            function completeHandler(event) {
                document.getElementById('status').innerHTML = event.target.responseText;
                document.getElementById('progressBar').value = 0;
                document.getElementById('progressBar').style.visibility='hidden';
                document.getElementById('status_bytes').innerHTML ='';
            }
            function errorHandler() {
                document.getElementById('status').innerHTML = "The upload failed !";
            }
            function abortHandler() {
                document.getElementById('status').innerHTML = "The upload was canceled !";
            }
        </script>
        <script>            
           function uploadLogoCentrale() {
               
                var file = document.getElementById('filelogocentrale').files[0];
                var data = new FormData();
                data.append('filelogocentrale', file);
                var ajax = new XMLHttpRequest();
                ajax.upload.addEventListener("progress", progressHandler2, false);
                ajax.addEventListener("load", completeHandler2, false);
                ajax.addEventListener("error", errorHandler2, false);
                ajax.addEventListener("abort", abortHandler2, false);
                ajax.open("POST", "<?php echo '/'.REPERTOIRE; ?>/rapport/uploadLogo.php");               
                ajax.send(data);
                deleteSource();
            }
            function progressHandler2(ev) {
                document.getElementById('progressBar2').style.visibility='visible';
                document.getElementById('status_bytes2').innerHTML = ev.loaded + ' bytes uploaded on ' + ev.total;
                var pourcentage = (ev.loaded / ev.total) * 100;
                document.getElementById('progressBar2').value = Math.round(pourcentage);
                document.getElementById('status2').innerHTML = Math.round(pourcentage) + '% uploaded... Wait';
                require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("cibleLogocentrale");});
            }
            function completeHandler2(evt) {
                document.getElementById('status2').innerHTML = evt.target.responseText;
                document.getElementById('progressBar2').value = 0;
                document.getElementById('progressBar2').style.visibility='hidden';
                document.getElementById('status_bytes2').innerHTML ='';                
            }
            function errorHandler2() {
                document.getElementById('status2').innerHTML = "The upload failed !";
            }
            function abortHandler2() {
                document.getElementById('status2').innerHTML = "The upload was canceled !";
            }            
        </script>      
        <script>            
           function uploadLogo() {
                
                var file = document.getElementById('filelogo').files[0];
                var data = new FormData();
                data.append('filelogo', file);
                var ajax = new XMLHttpRequest();
                ajax.upload.addEventListener("progress", progressHandler1, false);
                ajax.addEventListener("load", completeHandler1, false);
                ajax.addEventListener("error", errorHandler1, false);
                ajax.addEventListener("abort", abortHandler1, false);
                ajax.open("POST", "<?php echo '/'.REPERTOIRE; ?>/rapport/uploadLogo.php");
                ajax.send(data);
                deleteSource1();
            }
            function progressHandler1(ev) {
                document.getElementById('progressBar1').style.visibility='visible';
                document.getElementById('status_bytes1').innerHTML = ev.loaded + ' bytes uploaded on ' + ev.total;
                var pourcentage = (ev.loaded / ev.total) * 100;
                document.getElementById('progressBar1').value = Math.round(pourcentage);
                document.getElementById('status1').innerHTML = Math.round(pourcentage) + '% uploaded... Wait';
                require(["dojo/dom-construct"], function(domConstruct){domConstruct.destroy("cibleLogo");});
            }
            function completeHandler1(evt) {
                document.getElementById('status1').innerHTML = evt.target.responseText;
                document.getElementById('progressBar1').value = 0;
                document.getElementById('progressBar1').style.visibility='hidden';
                document.getElementById('status_bytes1').innerHTML ='';
            }
            function errorHandler1() {
                document.getElementById('status1').innerHTML = "The upload failed !";
            }
            function abortHandler1() {
                document.getElementById('status1').innerHTML = "The upload was canceled !";
            }
           
        </script>
<?php BD::deconnecter();?>
</form>