<div id="gridencoursrealisation" ></div>
<script>
    var gridencoursrealisation, dataStore, store;
    require([
        "dojox/grid/DataGrid",
        "dojo/store/Memory",
        "dojo/data/ObjectStore",
        "dojo/request",
        "dojo/date/stamp",
        "dojo/date/locale",
        "dojo/domReady!"
    ], function(DataGrid, Memory, ObjectStore, request, stamp, locale) {
        request.get('<?php echo "/".REPERTOIRE; ?>/tmp/ProjetEncoursRealisationcentrale.json', {
            handleAs: "json"
        }).then(function(data) {
            store = new Memory({data: data.items});
            dataStore = new ObjectStore({objectStore: store});
            function hrefFormatter(numero, idx) {
                var item = gridencoursrealisation.getItem(idx);//idx = index
                var centrale = item.libellecentrale;//libelle centrale
																var idstatut=item.idstatutprojet;
                return "<a  href=\"<?php echo '/'.REPERTOIRE;?>/controler/controlestatutprojet.php?lang=<?php echo $lang;?>&statut="+idstatut+"&numProjet=" + numero + "&centrale="
                        + centrale + "\">" + numero + "</a>";
            }
            function formatDate(datum) {
                var d = stamp.fromISOString(datum);
                 var annee =  datum.substring(0,4);
                if(annee>1970){
                    return locale.format(d, {selector: 'date', formatLength: 'short'});
                }
            }
            gridencoursrealisation = new DataGrid({
                store: dataStore,
                query: {id: "*"},
                structure: [
                    {name: "<?php echo TXT_NUMERO; ?>", field: "numero", width: "110px", formatter: hrefFormatter},
                    {name: "<?php echo TXT_DATEDEMANDE; ?>", field: "dateprojet", width: "150px", formatter: formatDate},
                    {name: "<?php echo TXT_TITREPROJET; ?>", field: "titre", width: "auto"},
                    {name: "<?php echo TXT_ACRONYME.' - '.TXT_REFINTERNE; ?>", field: "acronyme", width: "auto"},
                    {name: "<?php echo TXT_UPDATE; ?>", field: "datemaj", width: "80px", formatter: formatDate},
                    {name: "<?php echo TXT_DATEDEBUTPROJET; ?>", field: "datedebutprojet", width: "auto"},
                    {name: "<?php echo TXT_DATEFIN; ?>", field: "calcfinprojet", width: "120px", formatter: formatDate},
                    {name: "<?php echo TXT_DATEFIN.' proche'; ?>", field: "calcfinproche", width: "120px", formatter: formatDate}
                ]
            }, "gridencoursrealisation");
//----------------------------------------------------------------------------------------------------------------------
//                                        TEST METHODE
//----------------------------------------------------------------------------------------------------------------------
                    dojo.connect(dijit.byId('gridencoursrealisation'), 'onStyleRow', this, function(row) {
                        var item = gridencoursrealisation.getItem(row.index);
                        if (item) {                           
                            var datefin = gridencoursrealisation.store.getValue(item, "calcfinprojet", null);
                            var datefinProche = gridencoursrealisation.store.getValue(item, "calcfinproche", null);
                            if(!empty(datefin)){
                                var now = new Date();
                                var curr_month = now.getMonth();
                                if(curr_month<10){
                                    curr_month="0"+curr_month;
                                }
                                var maintenant = new Date (now.getFullYear() ,curr_month , now.getDate());
                                var dateFin = new Date(datefin);
                                var datefinproche = new Date(datefinProche);    
                                var maint = maintenant;
                                var fin = dateFin;
                                var finp =datefinproche;

                                if(maint>fin){
                                    row.customStyles += "color:red";
                                }else  if(maint >=finp){
                                    row.customStyles += "color:darkgoldenrod";
                                }else{
                                    row.customStyles += "color:darkgreen";
                                }
                            }
                        gridencoursrealisation.focus.styleRow(row);
                        gridencoursrealisation.edit.styleRow(row);
                    }
                    });
            gridencoursrealisation.startup();
        });
    });
</script>


