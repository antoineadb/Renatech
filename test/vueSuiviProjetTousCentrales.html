<?php include_once 'outils/constantes.php'; ?>
<div id="grid" ></div>
<script>
    var grid, dataStore, store;
    require([
        "dojox/grid/DataGrid",
        "dojo/store/Memory",
        "dojo/data/ObjectStore",
        "dojo/request",
        "dojo/date/stamp",
        "dojo/date/locale",
        "dojo/domReady!"
    ], function(DataGrid, Memory, ObjectStore, request, stamp, locale) {
        request.get("tmp/projetTousCentrales.json", {
            handleAs: "json"}).then(function(data) {
            store = new Memory({data: data.items});
            dataStore = new ObjectStore({objectStore: store});
            function hrefFormatterNumero(numero, idx) {
                var item = grid.getItem(idx);
                var centrale = item.libellecentrale;               
                var statut = +item.idstatutprojet;
                if (statut === +'<?php echo REFUSE; ?>' || statut === +'<?php echo CLOTURE; ?>') {
                    return numero;
                } else {
                    return "<a  href=\"controler/controlestatutprojet.php?lang=<?php echo $lang; ?>&statut=" + statut + "&numProjet=" + numero +"&centrale=" + centrale + "\">"+ numero + "</a>";
                }
            }
            function hrefFormatterPDF(index, idx) {
                var item = grid.getItem(idx);
                var numero = item.numero;
                return "<a  href=\"genererPDF.php?lang=<?php echo $lang; ?>&numProjet=" + numero + "\" target='_blank'>" +
                        '<img title="<?php echo TXT_GENERERPDF; ?>" src="styles/img/pdf_icongrid.png" />' + "</a>";
            }
            function hrefFormatterWord(index, idx) {
                var item = grid.getItem(idx);
                var idprojet = item.idprojet;
                return "<a  href=\"fichierRapport.php?lang=<?php echo $lang; ?>&idprojet=" + idprojet + "\" target='_blank'>" +
                        '<img title="<?php echo TXT_RAPPORTWORD; ?>" src="styles/img/imgwordgrid.png" />' + "</a>";
            }

            function formatDate(datum) {
                var d = stamp.fromISOString(datum);
                return locale.format(d, {selector: 'date', formatLength: 'long'});
            }
            grid = new DataGrid({
                store: dataStore,
                query: {id: "*"},
                structure: [
                    {name: "<?php echo TXT_NUMERO; ?>", field: "numero", width: "100px", formatter: hrefFormatterNumero},
                    {name: "<?php echo TXT_DATEDEMANDE; ?>", field: "dateprojet", width: "130px", formatter: formatDate},
                    {name: "<?php echo TXT_TITREPROJET; ?>", field: "titre", width: "220px  "},
                    {name: " ", field: "imprime", width: "34px", formatter: hrefFormatterPDF},
                    {name: " ", field: "word", width: "38px", formatter: hrefFormatterWord},                    
                    {name: "<?php echo TXT_STATUTPROJET?>", field: "libellestatutprojet", width: "110px"},
                    {name: "<?php echo TXT_NOMDEMANDEUR?>", field: "nom", width: "110px"},
                    {name: "<?php echo TXT_NOMLABORATOIRE?>", field: "entrepriselaboratoire", width: "110px"},
                    {name: "<?php echo TXT_NOMENTREPRISE ?>", field: "nomentreprise", width: "110px"},
                    {name: "<?php echo TXT_CENTRALE ?>", field: "libellecentrale", width: "50px"}
                ]
            }, "grid");
            grid.startup();
        });
    });
</script>
